<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="review.dao.ReviewMapper">

	<sql id="review-select">
		select  review_no, 
				title, 
				content, 
				hits, 
				recommend, 
				reg_date, 
				member_id
		from review
	</sql>
	
	<resultMap type="review" id="review-resultmap">
		<id column="review_no" property="reviewNo"/>
		<result column="title" property="title"/>
		<result column="content" property="content"/>
		<result column="hits" property="hits"/>
		<result column="recommend" property="recommend"/>
		<result column="reg_date" property="regDate"/>
		<result column="member_id" property="memberId"/>
	</resultMap>
	
	<!-- 등록 -->
	<insert id="insertReview" parameterType="review">
		<selectKey keyProperty="reviewNo" resultType="_int" order="BEFORE">
			select review_no_seq.nextval from dual
		</selectKey>
		insert into review (review_no, title, content, hits, recommend, reg_date, member_id)
		values (#{reviewNo}, #{title}, #{content}, #{hits}, #{recommend}, to_char(sysdate, 'yyyymmdd'), #{memberId})
	</insert>

	<!-- 수정 -->
	<update id="updateReview" parameterType="review">
		update  review
		set		title=#{title},
				content=#{content}
		where	review_no=#{reviewNo} and member_id=#{memberId}
	</update>
	
	<!-- 삭제 -->

	<delete id="deleteReview" parameterType="review">
		delete from review 
		where review_no=#{reviewNo} and member_id=#{memberId}
	</delete>
	
	<!-- 조회 -->
	<select id="selectReviewByNo" resultMap="review-resultmap" parameterType="int">
		<include refid="review-select"/>
		where review_no=#{reviewNo}
	</select>
	
	<!-- 조회수 증가 -->
	<select id="updateHits" parameterType="int">
		update review
		set hits = hits + 1
		where review_no=#{reviewNo}
	</select>
	
	<!-- 리뷰 목록 페이징 -->
		<select id="selectAllReviewPaging" parameterType="map" resultMap="review-resultmap">
		select review_no, title, content, hits, recommend, reg_date, member_id
		from (
				select ceil(rownum/#{contentsPerPage}) page, 
					   review_no, title, content, hits, 
					   recommend, reg_date, member_id
				from (
						<include refid="review-select"/>
						order by reg_date desc
			)
		) 
		where	page = #{pageNo}
	</select>
	
	<!-- 게시물 수  -->
	<select id="selectTotalReviewCount" resultType="_int">
		select count(review_no) from review
	</select>

</mapper>
